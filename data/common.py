"""
ê³µí†µ ë°ì´í„° & ìœ í‹¸ë¦¬í‹°
"""
import pandas as pd
import os, json
from datetime import datetime

# â”â”â” ê²½ë¡œ â”â”â”
_THIS_DIR = os.path.dirname(os.path.abspath(__file__))
_APP_DIR = os.path.dirname(_THIS_DIR)
SAVE_DIR = os.path.join(_APP_DIR, "saved")
os.makedirs(SAVE_DIR, exist_ok=True)

# â”â”â” ìŒë£Œ ë§¤ì¶œ ë°ì´í„° (ë°±ë§Œì›) â”â”â”
SALES_DATA = {
    "ì»¤í”¼ìŒë£Œ": {"2019":2100000,"2020":2250000,"2021":2380000,"2022":2520000,"2023":2680000,"2024":2850000},
    "íƒ„ì‚°ìŒë£Œ": {"2019":1890000,"2020":1920000,"2021":2050000,"2022":2180000,"2023":2350000,"2024":2480000},
    "ìƒìˆ˜":     {"2019":1450000,"2020":1580000,"2021":1720000,"2022":1890000,"2023":2050000,"2024":2200000},
    "ì—ë„ˆì§€ìŒë£Œ":{"2019":380000,"2020":450000,"2021":580000,"2022":720000,"2023":890000,"2024":1050000},
    "ìœ ì‚°ê· ìŒë£Œ":{"2019":680000,"2020":720000,"2021":760000,"2022":800000,"2023":830000,"2024":860000},
    "ê³¼ì±„ìŒë£Œ": {"2019":850000,"2020":830000,"2021":810000,"2022":790000,"2023":770000,"2024":760000},
    "ì°¨ìŒë£Œ":   {"2019":620000,"2020":640000,"2021":680000,"2022":710000,"2023":750000,"2024":790000},
    "ìŠ¤í¬ì¸ ìŒë£Œ":{"2019":520000,"2020":540000,"2021":560000,"2022":590000,"2023":620000,"2024":650000},
    "ë‘ìœ ":     {"2019":420000,"2020":410000,"2021":400000,"2022":395000,"2023":390000,"2024":385000},
    "ì‹í˜œ/ìˆ˜ì •ê³¼":{"2019":180000,"2020":175000,"2021":170000,"2022":168000,"2023":165000,"2024":163000},
}

BRAND_DATA = {
    "íƒ„ì‚°ìŒë£Œ": [
        {"brand":"ì½”ì¹´ì½œë¼","2019":580000,"2020":590000,"2021":620000,"2022":660000,"2023":710000,"2024":750000},
        {"brand":"ì¹ ì„±ì‚¬ì´ë‹¤","2019":410000,"2020":400000,"2021":420000,"2022":430000,"2023":460000,"2024":480000},
        {"brand":"í©ì‹œ","2019":320000,"2020":330000,"2021":360000,"2022":390000,"2023":420000,"2024":450000},
        {"brand":"ìŠ¤í”„ë¼ì´íŠ¸","2019":180000,"2020":190000,"2021":200000,"2022":210000,"2023":230000,"2024":250000},
        {"brand":"ë°€í‚¤ìŠ¤","2019":150000,"2020":155000,"2021":160000,"2022":165000,"2023":170000,"2024":175000},
    ],
    "ì»¤í”¼ìŒë£Œ": [
        {"brand":"ë§¥ì‹¬T.O.P","2019":520000,"2020":550000,"2021":580000,"2022":610000,"2023":650000,"2024":690000},
        {"brand":"ìŠ¤íƒ€ë²…ìŠ¤RTD","2019":280000,"2020":320000,"2021":370000,"2022":420000,"2023":480000,"2024":540000},
        {"brand":"ì¡°ì§€ì•„","2019":380000,"2020":400000,"2021":420000,"2022":440000,"2023":460000,"2024":480000},
        {"brand":"ì¹¸íƒ€íƒ€","2019":310000,"2020":320000,"2021":330000,"2022":340000,"2023":350000,"2024":360000},
        {"brand":"ë ˆì“°ë¹„","2019":250000,"2020":240000,"2021":230000,"2022":220000,"2023":210000,"2024":200000},
    ],
    "ì—ë„ˆì§€ìŒë£Œ": [
        {"brand":"ë ˆë“œë¶ˆ","2019":120000,"2020":140000,"2021":180000,"2022":220000,"2023":270000,"2024":320000},
        {"brand":"ëª¬ìŠ¤í„°","2019":95000,"2020":120000,"2021":160000,"2022":200000,"2023":250000,"2024":300000},
        {"brand":"í•«ì‹ìŠ¤","2019":85000,"2020":95000,"2021":110000,"2022":130000,"2023":150000,"2024":170000},
        {"brand":"ì…€ë ‰ìŠ¤","2019":30000,"2020":40000,"2021":55000,"2022":75000,"2023":100000,"2024":130000},
    ],
    "ìƒìˆ˜": [
        {"brand":"ì œì£¼ì‚¼ë‹¤ìˆ˜","2019":450000,"2020":500000,"2021":550000,"2022":610000,"2023":670000,"2024":720000},
        {"brand":"ì•„ì´ì‹œìŠ¤","2019":280000,"2020":300000,"2021":320000,"2022":350000,"2023":380000,"2024":410000},
        {"brand":"ë°±ì‚°ìˆ˜","2019":180000,"2020":200000,"2021":230000,"2022":260000,"2023":290000,"2024":320000},
    ],
    "ìœ ì‚°ê· ìŒë£Œ": [
        {"brand":"ì•¼ì¿ ë¥´íŠ¸","2019":280000,"2020":290000,"2021":300000,"2022":310000,"2023":320000,"2024":330000},
        {"brand":"ìœŒ","2019":150000,"2020":160000,"2021":175000,"2022":190000,"2023":200000,"2024":210000},
        {"brand":"ì¿ í¼ìŠ¤","2019":80000,"2020":90000,"2021":100000,"2022":110000,"2023":120000,"2024":130000},
    ],
}

PRODUCT_CARDS = {
    "ì½”ì¹´ì½œë¼": {"emoji":"ğŸ¥¤","desc":"ëŒ€í‘œ íƒ„ì‚°ìŒë£Œ, ë…ìì  ì›ì•¡ ë°°í•©","category":"íƒ„ì‚°ìŒë£Œ"},
    "í©ì‹œ": {"emoji":"ğŸ¥¤","desc":"ê¸€ë¡œë²Œ íƒ„ì‚°ìŒë£Œ, ì‹œíŠ¸ëŸ¬ìŠ¤ í’ë¯¸","category":"íƒ„ì‚°ìŒë£Œ"},
    "ì¹ ì„±ì‚¬ì´ë‹¤": {"emoji":"ğŸ«§","desc":"ë ˆëª¬ë¼ì„í–¥ ë¬´ì¹´í˜ì¸ íƒ„ì‚°ìŒë£Œ","category":"íƒ„ì‚°ìŒë£Œ"},
    "ë§¥ì‹¬T.O.P": {"emoji":"â˜•","desc":"í”„ë¦¬ë¯¸ì—„ RTD ì»¤í”¼, ì½œë“œë¸Œë£¨","category":"ì»¤í”¼ìŒë£Œ"},
    "ìŠ¤íƒ€ë²…ìŠ¤RTD": {"emoji":"â˜•","desc":"ìŠ¤íƒ€ë²…ìŠ¤ ì›ë‘ ì‚¬ìš© RTD","category":"ì»¤í”¼ìŒë£Œ"},
    "ë ˆë“œë¶ˆ": {"emoji":"âš¡","desc":"íƒ€ìš°ë¦°+ì¹´í˜ì¸ ì—ë„ˆì§€ìŒë£Œ","category":"ì—ë„ˆì§€ìŒë£Œ"},
    "ëª¬ìŠ¤í„°": {"emoji":"âš¡","desc":"ê³ ì¹´í˜ì¸ ì—ë„ˆì§€, ë‹¤ì–‘í•œ ë¼ì¸ì—…","category":"ì—ë„ˆì§€ìŒë£Œ"},
    "ì œì£¼ì‚¼ë‹¤ìˆ˜": {"emoji":"ğŸ’§","desc":"ì œì£¼ í™”ì‚°ì•”ë°˜ìˆ˜ ë¯¸ë„¤ë„ì›Œí„°","category":"ìƒìˆ˜"},
    "ì•¼ì¿ ë¥´íŠ¸": {"emoji":"ğŸ§«","desc":"ìœ ì‚°ê·  ë°œíš¨ìœ , ë½í† ë°”ì‹¤ëŸ¬ìŠ¤","category":"ìœ ì‚°ê· ìŒë£Œ"},
}

PROCESS_STEPS = [
    {"id":1,"name":"ì›ë£Œ ì…ê³ Â·ê²€ìˆ˜","icon":"ğŸ“¦","risk":"ì´ë¬¼ í˜¼ì…, ì„±ì ì„œ ë¯¸ë¹„","control":"ì…ê³ ê²€ì‚¬ SOP, COA í™•ì¸","level":"low"},
    {"id":2,"name":"ê³„ëŸ‰Â·ë°°í•©","icon":"âš–ï¸","risk":"ë°°í•© ì˜¤ì°¨, êµì°¨ì˜¤ì—¼","control":"ì „ìì €ìš¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜, ë°°í•©ì¼ì§€","level":"mid"},
    {"id":3,"name":"ìš©í•´Â·í˜¼í•©","icon":"ğŸ”„","risk":"ìš©í•´ ë¶ˆëŸ‰, ì˜¨ë„ ì´íƒˆ","control":"êµë°˜ì†ë„/ì˜¨ë„/ì‹œê°„ ëª¨ë‹ˆí„°ë§","level":"mid"},
    {"id":4,"name":"ê· ì§ˆí™”","icon":"ğŸ§ª","risk":"ì…ì ë¶ˆê· ì¼","control":"ê· ì§ˆì••ë ¥Â·íŒ¨ìŠ¤ íšŸìˆ˜ ì„¤ì •","level":"low"},
    {"id":5,"name":"ì‚´ê· ","icon":"ğŸ”¥","risk":"ì‚´ê·  ë¶€ì¡±/ê³¼ë„","control":"HTST 72Â°C/15s ë˜ëŠ” UHT 135Â°C/2s","level":"high"},
    {"id":6,"name":"ëƒ‰ê°","icon":"â„ï¸","risk":"ë¯¸ìƒë¬¼ ì¬ì˜¤ì—¼","control":"ë°€íì‹ ëƒ‰ê°, ì˜¨ë„ ê¸°ë¡","level":"mid"},
    {"id":7,"name":"ì¶©ì „Â·ë°€ë´‰","icon":"ğŸ«™","risk":"ìš©ê¸° ë¶ˆëŸ‰, ë°€ë´‰ ëˆ„ì„¤","control":"ì¶©ì „ëŸ‰ ê²€ì‚¬, ê¸°ë°€ì‹œí—˜","level":"high"},
    {"id":8,"name":"ê²€ì‚¬Â·ì¶œí•˜","icon":"âœ…","risk":"ë¶€ì í•© ì¶œí•˜","control":"ê´€ëŠ¥Â·ì´í™”í•™Â·ë¯¸ìƒë¬¼ ê²€ì‚¬","level":"low"},
]

SAMPLE_FORMULATIONS = {
    "íƒ„ì‚°ìŒë£Œ ê¸°ë³¸í˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,430,86.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,55,11.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,2.5,0.5,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤(CO2),4.0,0.8,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\nì²œì—°í–¥ë£Œ,1.5,0.3,í’ë¯¸,ì²œì—°í–¥ë£Œ\nì¹´ë¼ë©œìƒ‰ì†Œ,0.8,0.16,ì°©ìƒ‰,ì‹í’ˆì²¨ê°€ë¬¼",
    "ì—ë„ˆì§€ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,410,82.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,52,10.4,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\níƒ€ìš°ë¦°,1.0,0.2,ê¸°ëŠ¥ì„±,ì‹í’ˆì²¨ê°€ë¬¼\nì¹´í˜ì¸,0.15,0.03,ê°ì„±,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,3.0,0.6,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤,3.5,0.7,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\ní•©ì„±í–¥ë£Œ,1.2,0.24,í’ë¯¸,í•©ì„±í–¥ë£Œ",
    "ê³¼ì±„ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,300,60.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nì˜¤ë Œì§€ë†ì¶•ê³¼ì¦™,100,20.0,ê³¼ì¦™,ì²œì—°ì›ë£Œ\nì‚¬ê³¼ë†ì¶•ê³¼ì¦™,50,10.0,ê³¼ì¦™,ì²œì—°ì›ë£Œ\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,30,6.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,2.0,0.4,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\në¹„íƒ€ë¯¼C,0.5,0.1,ì‚°í™”ë°©ì§€,ì‹í’ˆì²¨ê°€ë¬¼\ní™í‹´,1.5,0.3,ì•ˆì •ì œ,ì‹í’ˆì²¨ê°€ë¬¼",
    "ìœ ì‚°ê· ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\níƒˆì§€ë¶„ìœ í™˜ì›ì•¡,350,70.0,ê¸°ì§ˆ,ì²œì—°ì›ë£Œ\ní¬ë„ë‹¹,50,10.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nê³¼ë‹¹,30,6.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nìœ ì‚°ê· ë°°ì–‘ì•¡,20,4.0,ë°œíš¨,ìƒê· ì œ\nêµ¬ì—°ì‚°,3.0,0.6,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\ní™í‹´,2.0,0.4,ì•ˆì •,ì‹í’ˆì²¨ê°€ë¬¼\nì •ì œìˆ˜,44,8.8,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜",
    "ì €ë‹¹ ìŠ¤íŒŒí´ë§í˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,445,89.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nì—ë¦¬ìŠ¤ë¦¬í†¨,8,1.6,ê°ë¯¸(ì €ë‹¹),ëŒ€ì²´ê°ë¯¸ë£Œ\nìˆ˜í¬ë„ë¡œìŠ¤,0.03,0.006,ê³ ê°ë¯¸,ëŒ€ì²´ê°ë¯¸ë£Œ\nêµ¬ì—°ì‚°,2.5,0.5,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤,4.0,0.8,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\në ˆëª¬ë†ì¶•ê³¼ì¦™,3.0,0.6,í’ë¯¸,ì²œì—°ì›ë£Œ\në¹„íƒ€ë¯¼C,0.3,0.06,ì‚°í™”ë°©ì§€,ì‹í’ˆì²¨ê°€ë¬¼",
}

YEARS = ["2019","2020","2021","2022","2023","2024"]
COLORS = ["#0EA5E9","#F59E0B","#10B981","#EF4444","#8B5CF6","#EC4899","#14B8A6","#F97316","#6366F1","#84CC16"]

# â”â”â” ì›ì¬ë£Œ ë‹¨ê°€ (ì›/kg ë˜ëŠ” ì›/L) â”â”â”
INGREDIENT_COSTS = {
    "ì •ì œìˆ˜":        {"unit_price": 5, "unit": "ì›/L", "supplier": "ìì²´/ì‹œìˆ˜", "moq": "-"},
    "ê³¼ë‹¹í¬ë„ë‹¹ì•¡":   {"unit_price": 1200, "unit": "ì›/kg", "supplier": "ì‚¼ì–‘ì‚¬/ëŒ€ìƒ", "moq": "20kg"},
    "ì„¤íƒ•(ë°±ì„¤íƒ•)":   {"unit_price": 1500, "unit": "ì›/kg", "supplier": "CJ/ì‚¼ì–‘ì‚¬", "moq": "25kg"},
    "ì—ë¦¬ìŠ¤ë¦¬í†¨":     {"unit_price": 8500, "unit": "ì›/kg", "supplier": "CJ", "moq": "25kg"},
    "ìˆ˜í¬ë„ë¡œìŠ¤":     {"unit_price": 180000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…(ì¤‘êµ­)", "moq": "1kg"},
    "ìŠ¤í…Œë¹„ì•„ì¶”ì¶œë¬¼":  {"unit_price": 95000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "5kg"},
    "ì•„ìŠ¤íŒŒíƒ":       {"unit_price": 45000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "5kg"},
    "êµ¬ì—°ì‚°":        {"unit_price": 3500, "unit": "ì›/kg", "supplier": "ADM/ëŒ€ìƒ", "moq": "25kg"},
    "êµ¬ì—°ì‚°ë‚˜íŠ¸ë¥¨":   {"unit_price": 5500, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "ì¸ì‚°":          {"unit_price": 4200, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "ì –ì‚°":          {"unit_price": 6000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "íƒ„ì‚°ê°€ìŠ¤(CO2)":  {"unit_price": 800, "unit": "ì›/kg", "supplier": "ê°€ìŠ¤ì—…ì²´", "moq": "50kg"},
    "íƒ„ì‚°ê°€ìŠ¤":       {"unit_price": 800, "unit": "ì›/kg", "supplier": "ê°€ìŠ¤ì—…ì²´", "moq": "50kg"},
    "ì²œì—°í–¥ë£Œ":       {"unit_price": 85000, "unit": "ì›/kg", "supplier": "ì§€ë³´ë‹¨/IFF", "moq": "5kg"},
    "í•©ì„±í–¥ë£Œ":       {"unit_price": 45000, "unit": "ì›/kg", "supplier": "ì§€ë³´ë‹¨/IFF", "moq": "5kg"},
    "ì¹´ë¼ë©œìƒ‰ì†Œ":     {"unit_price": 7500, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "ë¹„íƒ€ë¯¼C":       {"unit_price": 25000, "unit": "ì›/kg", "supplier": "DSM/ìˆ˜ì…", "moq": "25kg"},
    "ë¹„íƒ€ë¯¼Bêµ°":      {"unit_price": 120000, "unit": "ì›/kg", "supplier": "DSM", "moq": "1kg"},
    "íƒ€ìš°ë¦°":        {"unit_price": 35000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…(ì¤‘êµ­)", "moq": "25kg"},
    "ì¹´í˜ì¸":        {"unit_price": 65000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "5kg"},
    "L-ì•„ë¥´ê¸°ë‹Œ":    {"unit_price": 42000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "ì˜¤ë Œì§€ë†ì¶•ê³¼ì¦™":  {"unit_price": 8500, "unit": "ì›/kg", "supplier": "ë¸Œë¼ì§ˆ/ë¯¸êµ­", "moq": "200kg"},
    "ì‚¬ê³¼ë†ì¶•ê³¼ì¦™":   {"unit_price": 5500, "unit": "ì›/kg", "supplier": "ì¤‘êµ­/êµ­ì‚°", "moq": "200kg"},
    "ë ˆëª¬ë†ì¶•ê³¼ì¦™":   {"unit_price": 9000, "unit": "ì›/kg", "supplier": "ì´íƒˆë¦¬ì•„", "moq": "200kg"},
    "í¬ë„ë†ì¶•ê³¼ì¦™":   {"unit_price": 6500, "unit": "ì›/kg", "supplier": "ì¹ ë ˆ/ìŠ¤í˜ì¸", "moq": "200kg"},
    "íƒˆì§€ë¶„ìœ í™˜ì›ì•¡":  {"unit_price": 3200, "unit": "ì›/L", "supplier": "ì„œìš¸ìš°ìœ /ë§¤ì¼", "moq": "200L"},
    "ìœ ì‚°ê· ë°°ì–‘ì•¡":   {"unit_price": 45000, "unit": "ì›/L", "supplier": "CKDë°”ì´ì˜¤/ìˆ˜ì…", "moq": "10L"},
    "í¬ë„ë‹¹":        {"unit_price": 1800, "unit": "ì›/kg", "supplier": "ì‚¼ì–‘ì‚¬", "moq": "25kg"},
    "ê³¼ë‹¹":          {"unit_price": 2000, "unit": "ì›/kg", "supplier": "ì‚¼ì–‘ì‚¬", "moq": "25kg"},
    "í™í‹´":          {"unit_price": 55000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…(ë´ë§ˆí¬)", "moq": "25kg"},
    "ì”íƒ„ê²€":        {"unit_price": 28000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "CMC":           {"unit_price": 15000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…", "moq": "25kg"},
    "ë‹ˆì½”í‹´ì‚°ì•„ë¯¸ë“œ":  {"unit_price": 95000, "unit": "ì›/kg", "supplier": "DSM", "moq": "1kg"},
    "íŒí† í…ì‚°ì¹¼ìŠ˜":   {"unit_price": 110000, "unit": "ì›/kg", "supplier": "DSM", "moq": "1kg"},
    "í™ì‚¼ë†ì¶•ì•¡":     {"unit_price": 120000, "unit": "ì›/kg", "supplier": "ì •ê´€ì¥/KGC", "moq": "10kg"},
    "ì½œë¼ê²í©íƒ€ì´ë“œ":  {"unit_price": 35000, "unit": "ì›/kg", "supplier": "ìˆ˜ì…(ì¼ë³¸)", "moq": "25kg"},
}

# â”â”â” í‘œì¤€ ë°°í•©ë¹„ (ë¹„êµ ê¸°ì¤€ìš©, 100% ê¸°ì¤€) â”â”â”
STANDARD_FORMULATIONS = {
    "íƒ„ì‚°ìŒë£Œ í‘œì¤€ (ì½œë¼íƒ€ì…)": {
        "type": "íƒ„ì‚°ìŒë£Œ", "brix": 10.5, "pH": 3.2,
        "ingredients": [
            {"ì›ë£Œëª…":"ì •ì œìˆ˜","ë¹„ìœ¨(%)":87.17,"ê¸°ëŠ¥":"ìš©ë§¤","ë“±ê¸‰":"ì‹í’ˆìš©ìˆ˜"},
            {"ì›ë£Œëª…":"ê³¼ë‹¹í¬ë„ë‹¹ì•¡","ë¹„ìœ¨(%)":11.0,"ê¸°ëŠ¥":"ê°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"êµ¬ì—°ì‚°","ë¹„ìœ¨(%)":0.5,"ê¸°ëŠ¥":"ì‚°ë¯¸ì¡°ì ˆ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"íƒ„ì‚°ê°€ìŠ¤(CO2)","ë¹„ìœ¨(%)":0.8,"ê¸°ëŠ¥":"íƒ„ì‚°","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ì¹´ë¼ë©œìƒ‰ì†Œ","ë¹„ìœ¨(%)":0.16,"ê¸°ëŠ¥":"ì°©ìƒ‰","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ì²œì—°í–¥ë£Œ","ë¹„ìœ¨(%)":0.3,"ê¸°ëŠ¥":"í’ë¯¸","ë“±ê¸‰":"ì²œì—°í–¥ë£Œ"},
            {"ì›ë£Œëª…":"ì¸ì‚°","ë¹„ìœ¨(%)":0.07,"ê¸°ëŠ¥":"ì‚°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
        ],
    },
    "ì—ë„ˆì§€ìŒë£Œ í‘œì¤€": {
        "type": "ì—ë„ˆì§€ìŒë£Œ", "brix": 11.0, "pH": 3.4,
        "ingredients": [
            {"ì›ë£Œëª…":"ì •ì œìˆ˜","ë¹„ìœ¨(%)":87.826,"ê¸°ëŠ¥":"ìš©ë§¤","ë“±ê¸‰":"ì‹í’ˆìš©ìˆ˜"},
            {"ì›ë£Œëª…":"ê³¼ë‹¹í¬ë„ë‹¹ì•¡","ë¹„ìœ¨(%)":10.4,"ê¸°ëŠ¥":"ê°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"íƒ€ìš°ë¦°","ë¹„ìœ¨(%)":0.2,"ê¸°ëŠ¥":"ê¸°ëŠ¥ì„±","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ì¹´í˜ì¸","ë¹„ìœ¨(%)":0.03,"ê¸°ëŠ¥":"ê°ì„±","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"êµ¬ì—°ì‚°","ë¹„ìœ¨(%)":0.6,"ê¸°ëŠ¥":"ì‚°ë¯¸ì¡°ì ˆ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"íƒ„ì‚°ê°€ìŠ¤(CO2)","ë¹„ìœ¨(%)":0.7,"ê¸°ëŠ¥":"íƒ„ì‚°","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ë¹„íƒ€ë¯¼Bêµ°","ë¹„ìœ¨(%)":0.004,"ê¸°ëŠ¥":"ì˜ì–‘ê°•í™”","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"í•©ì„±í–¥ë£Œ","ë¹„ìœ¨(%)":0.24,"ê¸°ëŠ¥":"í’ë¯¸","ë“±ê¸‰":"í•©ì„±í–¥ë£Œ"},
        ],
    },
    "ê³¼ì±„ìŒë£Œ í‘œì¤€ (ê³¼ì¦™10%ì´ìƒ)": {
        "type": "ê³¼ì±„ìŒë£Œ", "brix": 12.0, "pH": 3.8,
        "ingredients": [
            {"ì›ë£Œëª…":"ì •ì œìˆ˜","ë¹„ìœ¨(%)":63.2,"ê¸°ëŠ¥":"ìš©ë§¤","ë“±ê¸‰":"ì‹í’ˆìš©ìˆ˜"},
            {"ì›ë£Œëª…":"ì˜¤ë Œì§€ë†ì¶•ê³¼ì¦™","ë¹„ìœ¨(%)":20.0,"ê¸°ëŠ¥":"ê³¼ì¦™","ë“±ê¸‰":"ì²œì—°ì›ë£Œ"},
            {"ì›ë£Œëª…":"ì‚¬ê³¼ë†ì¶•ê³¼ì¦™","ë¹„ìœ¨(%)":10.0,"ê¸°ëŠ¥":"ê³¼ì¦™","ë“±ê¸‰":"ì²œì—°ì›ë£Œ"},
            {"ì›ë£Œëª…":"ê³¼ë‹¹í¬ë„ë‹¹ì•¡","ë¹„ìœ¨(%)":6.0,"ê¸°ëŠ¥":"ê°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"êµ¬ì—°ì‚°","ë¹„ìœ¨(%)":0.4,"ê¸°ëŠ¥":"ì‚°ë¯¸ì¡°ì ˆ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ë¹„íƒ€ë¯¼C","ë¹„ìœ¨(%)":0.1,"ê¸°ëŠ¥":"ì‚°í™”ë°©ì§€","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"í™í‹´","ë¹„ìœ¨(%)":0.3,"ê¸°ëŠ¥":"ì•ˆì •ì œ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
        ],
    },
    "ìœ ì‚°ê· ìŒë£Œ í‘œì¤€": {
        "type": "ìœ ì‚°ê· ìŒë£Œ", "brix": 15.0, "pH": 3.8,
        "ingredients": [
            {"ì›ë£Œëª…":"íƒˆì§€ë¶„ìœ í™˜ì›ì•¡","ë¹„ìœ¨(%)":70.0,"ê¸°ëŠ¥":"ê¸°ì§ˆ","ë“±ê¸‰":"ì²œì—°ì›ë£Œ"},
            {"ì›ë£Œëª…":"í¬ë„ë‹¹","ë¹„ìœ¨(%)":10.0,"ê¸°ëŠ¥":"ê°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ê³¼ë‹¹","ë¹„ìœ¨(%)":6.0,"ê¸°ëŠ¥":"ê°ë¯¸","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ìœ ì‚°ê· ë°°ì–‘ì•¡","ë¹„ìœ¨(%)":4.0,"ê¸°ëŠ¥":"ë°œíš¨","ë“±ê¸‰":"ìƒê· ì œ"},
            {"ì›ë£Œëª…":"êµ¬ì—°ì‚°","ë¹„ìœ¨(%)":0.6,"ê¸°ëŠ¥":"ì‚°ë¯¸ì¡°ì ˆ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"í™í‹´","ë¹„ìœ¨(%)":0.4,"ê¸°ëŠ¥":"ì•ˆì •","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ì •ì œìˆ˜","ë¹„ìœ¨(%)":9.0,"ê¸°ëŠ¥":"ìš©ë§¤","ë“±ê¸‰":"ì‹í’ˆìš©ìˆ˜"},
        ],
    },
    "ì €ë‹¹ ìŠ¤íŒŒí´ë§ í‘œì¤€": {
        "type": "ì €ë‹¹ìŒë£Œ", "brix": 2.0, "pH": 3.5,
        "ingredients": [
            {"ì›ë£Œëª…":"ì •ì œìˆ˜","ë¹„ìœ¨(%)":96.434,"ê¸°ëŠ¥":"ìš©ë§¤","ë“±ê¸‰":"ì‹í’ˆìš©ìˆ˜"},
            {"ì›ë£Œëª…":"ì—ë¦¬ìŠ¤ë¦¬í†¨","ë¹„ìœ¨(%)":1.6,"ê¸°ëŠ¥":"ê°ë¯¸(ì €ë‹¹)","ë“±ê¸‰":"ëŒ€ì²´ê°ë¯¸ë£Œ"},
            {"ì›ë£Œëª…":"ìˆ˜í¬ë„ë¡œìŠ¤","ë¹„ìœ¨(%)":0.006,"ê¸°ëŠ¥":"ê³ ê°ë¯¸","ë“±ê¸‰":"ëŒ€ì²´ê°ë¯¸ë£Œ"},
            {"ì›ë£Œëª…":"êµ¬ì—°ì‚°","ë¹„ìœ¨(%)":0.5,"ê¸°ëŠ¥":"ì‚°ë¯¸ì¡°ì ˆ","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"íƒ„ì‚°ê°€ìŠ¤(CO2)","ë¹„ìœ¨(%)":0.8,"ê¸°ëŠ¥":"íƒ„ì‚°","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
            {"ì›ë£Œëª…":"ë ˆëª¬ë†ì¶•ê³¼ì¦™","ë¹„ìœ¨(%)":0.6,"ê¸°ëŠ¥":"í’ë¯¸","ë“±ê¸‰":"ì²œì—°ì›ë£Œ"},
            {"ì›ë£Œëª…":"ë¹„íƒ€ë¯¼C","ë¹„ìœ¨(%)":0.06,"ê¸°ëŠ¥":"ì‚°í™”ë°©ì§€","ë“±ê¸‰":"ì‹í’ˆì²¨ê°€ë¬¼"},
        ],
    },
}


# â”â”â” ìœ í‹¸ë¦¬í‹° â”â”â”
def get_sorted_categories():
    """2024 ë§¤ì¶œ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬"""
    return sorted(SALES_DATA.keys(), key=lambda c: SALES_DATA[c]["2024"], reverse=True)

def parse_csv_formula(text):
    """CSV í…ìŠ¤íŠ¸ â†’ DataFrame íŒŒì‹±"""
    import io
    if not text.strip():
        return None, "ë¹ˆ ì…ë ¥"
    try:
        lines = text.strip().split("\n")
        if len(lines) < 2:
            return None, "ìµœì†Œ í—¤ë”+1í–‰ í•„ìš”"
        df = pd.read_csv(io.StringIO(text))
        # ì»¬ëŸ¼ í‘œì¤€í™”
        col_map = {}
        for c in df.columns:
            cl = c.strip().lower()
            if "ì›ë£Œ" in cl or "name" in cl: col_map[c] = "ì›ë£Œëª…"
            elif "í•¨ëŸ‰" in cl or "amount" in cl: col_map[c] = "í•¨ëŸ‰"
            elif "ë¹„ìœ¨" in cl or "%" in cl or "pct" in cl: col_map[c] = "ë¹„ìœ¨(%)"
            elif "ê¸°ëŠ¥" in cl or "func" in cl: col_map[c] = "ê¸°ëŠ¥"
            elif "ë“±ê¸‰" in cl or "grade" in cl: col_map[c] = "ë“±ê¸‰"
        df = df.rename(columns=col_map)
        if "ì›ë£Œëª…" not in df.columns:
            return None, "'ì›ë£Œëª…' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        if "ë¹„ìœ¨(%)" in df.columns:
            df["ë¹„ìœ¨(%)"] = pd.to_numeric(df["ë¹„ìœ¨(%)"], errors="coerce").fillna(0)
        return df, "OK"
    except Exception as e:
        return None, str(e)

def validate_formula(df, meta=None):
    """ë°°í•©ë¹„ ê²€ì¦"""
    issues, warnings = [], []
    if "ë¹„ìœ¨(%)" in df.columns:
        total = df["ë¹„ìœ¨(%)"].sum()
        if total < 99:
            issues.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% â€” 100%ì— ë¯¸ë‹¬ ({100-total:.1f}% ë¶€ì¡±)")
        elif total > 101:
            issues.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% â€” 100% ì´ˆê³¼")
        else:
            warnings.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% âœ“")
    
    names = df["ì›ë£Œëª…"].str.lower().tolist() if "ì›ë£Œëª…" in df.columns else []
    if not any("ì •ì œìˆ˜" in n or "ë¬¼" in n for n in names):
        warnings.append("ì •ì œìˆ˜(ì‹í’ˆìš©ìˆ˜)ê°€ ì—†ìŠµë‹ˆë‹¤")
    if "ê¸°ëŠ¥" in df.columns:
        funcs = df["ê¸°ëŠ¥"].str.lower().fillna("").tolist()
        if not any("ê°ë¯¸" in f for f in funcs):
            warnings.append("ê°ë¯¸ë£Œê°€ ì—†ìŠµë‹ˆë‹¤")
        if not any("ì‚°ë¯¸" in f for f in funcs):
            warnings.append("ì‚°ë¯¸ë£Œê°€ ì—†ìŠµë‹ˆë‹¤")
    if len(df) < 3:
        issues.append("ì›ë£Œ 3ì¢… ë¯¸ë§Œ")
    
    if meta:
        brix = meta.get("brix")
        if brix and (brix < 1 or brix > 70):
            issues.append(f"Brix {brix}Â° â€” ë²”ìœ„(1~70Â°) ë²—ì–´ë‚¨")
        pH = meta.get("pH")
        if pH and (pH < 2 or pH > 8):
            issues.append(f"pH {pH} â€” ë²”ìœ„(2~8) ë²—ì–´ë‚¨")
    
    return {"issues": issues, "warnings": warnings, "passed": len(issues) == 0}

def save_formula(name, df, meta, student_name="default"):
    """ë°°í•©ë¹„ë¥¼ JSONìœ¼ë¡œ ì €ì¥"""
    filepath = os.path.join(SAVE_DIR, f"{student_name}_{name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json")
    data = {
        "name": name,
        "student": student_name,
        "meta": meta,
        "ingredients": df.to_dict(orient="records"),
        "timestamp": datetime.now().isoformat(),
    }
    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    return filepath

def load_saved_formulas():
    """ì €ì¥ëœ ë°°í•©ë¹„ ëª©ë¡"""
    results = []
    for fn in sorted(os.listdir(SAVE_DIR), reverse=True):
        if fn.endswith(".json"):
            try:
                with open(os.path.join(SAVE_DIR, fn), "r", encoding="utf-8") as f:
                    data = json.load(f)
                data["filename"] = fn
                results.append(data)
            except:
                pass
    return results


def calc_cost_table(df, volume_ml=500):
    """ë°°í•©ë¹„ DataFrameì— ì›ê°€ ì»¬ëŸ¼ ì¶”ê°€"""
    costs = []
    for _, row in df.iterrows():
        name = row.get("ì›ë£Œëª…", "")
        pct = float(row.get("ë¹„ìœ¨(%)", 0))
        # ì›ë£Œëª…ìœ¼ë¡œ ë‹¨ê°€ ê²€ìƒ‰ (ë¶€ë¶„ ë§¤ì¹­)
        unit_price = 0
        matched = ""
        for key, info in INGREDIENT_COSTS.items():
            if key in name or name in key:
                unit_price = info["unit_price"]
                matched = key
                break
        # g ê¸°ì¤€ í™˜ì‚°: volume_ml * pct/100 = g, ë‹¨ê°€ëŠ” ì›/kgì´ë¯€ë¡œ /1000
        amount_g = volume_ml * pct / 100
        cost_per_unit = amount_g * unit_price / 1000  # ì›
        costs.append({
            "ì›ë£Œëª…": name,
            "ë¹„ìœ¨(%)": pct,
            "í•¨ëŸ‰(g)": round(amount_g, 2),
            "ë‹¨ê°€(ì›/kg)": unit_price,
            "ì›ê°€(ì›)": round(cost_per_unit, 2),
            "ë§¤ì¹­ì›ë£Œ": matched,
        })
    return pd.DataFrame(costs)


def compare_formulations(df_mine, df_standard):
    """ë‚´ ë°°í•©ë¹„ vs í‘œì¤€ë°°í•©ë¹„ ë¹„êµ"""
    result = []
    all_names = set()
    mine_dict = {}
    std_dict = {}

    if "ì›ë£Œëª…" in df_mine.columns and "ë¹„ìœ¨(%)" in df_mine.columns:
        for _, r in df_mine.iterrows():
            mine_dict[r["ì›ë£Œëª…"]] = float(r["ë¹„ìœ¨(%)"])
            all_names.add(r["ì›ë£Œëª…"])

    if "ì›ë£Œëª…" in df_standard.columns and "ë¹„ìœ¨(%)" in df_standard.columns:
        for _, r in df_standard.iterrows():
            std_dict[r["ì›ë£Œëª…"]] = float(r["ë¹„ìœ¨(%)"])
            all_names.add(r["ì›ë£Œëª…"])

    for name in sorted(all_names):
        mine_val = mine_dict.get(name, 0)
        std_val = std_dict.get(name, 0)
        diff = mine_val - std_val
        result.append({
            "ì›ë£Œëª…": name,
            "ë‚´ ë°°í•©(%)": mine_val,
            "í‘œì¤€(%)": std_val,
            "ì°¨ì´(%)": round(diff, 3),
            "íŒì •": "âœ… ë™ì¼" if abs(diff) < 0.01 else ("â¬†ï¸ ì´ˆê³¼" if diff > 0 else "â¬‡ï¸ ë¶€ì¡±"),
        })
    return pd.DataFrame(result)


def extract_pdf_text(uploaded_file):
    """ì—…ë¡œë“œëœ PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ë‹¤ì¤‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ í´ë°±)"""
    import io
    # íŒŒì¼ ë°”ì´íŠ¸ë¥¼ ë¨¼ì € ì½ì–´ë‘ê¸° (seek ë¬¸ì œ ë°©ì§€)
    try:
        uploaded_file.seek(0)
    except:
        pass
    try:
        raw = uploaded_file.read()
    except:
        return None, "íŒŒì¼ ì½ê¸° ì‹¤íŒ¨"
    if not raw or len(raw) < 100:
        return None, "íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤"

    # ë°©ë²• 1: pypdf
    try:
        from pypdf import PdfReader
        reader = PdfReader(io.BytesIO(raw))
        text = ""
        for page in reader.pages:
            t = page.extract_text()
            if t:
                text += t + "\n"
        if text.strip():
            return text, f"pypdfë¡œ {len(reader.pages)}í˜ì´ì§€ ì¶”ì¶œ ì™„ë£Œ"
    except ImportError:
        pass
    except Exception as e:
        pass  # ë‹¤ìŒ ë°©ë²• ì‹œë„

    # ë°©ë²• 2: pdfplumber (í‘œ/ë³µì¡í•œ ë ˆì´ì•„ì›ƒì— ê°•í•¨)
    try:
        import pdfplumber
        with pdfplumber.open(io.BytesIO(raw)) as pdf:
            text = ""
            for page in pdf.pages:
                t = page.extract_text()
                if t:
                    text += t + "\n"
        if text.strip():
            return text, f"pdfplumberë¡œ {len(pdf.pages)}í˜ì´ì§€ ì¶”ì¶œ ì™„ë£Œ"
    except ImportError:
        pass
    except Exception as e:
        pass

    # ë°©ë²• 3: PyPDF2 (ë ˆê±°ì‹œ)
    try:
        import PyPDF2
        reader = PyPDF2.PdfReader(io.BytesIO(raw))
        text = ""
        for page in reader.pages:
            t = page.extract_text()
            if t:
                text += t + "\n"
        if text.strip():
            return text, f"PyPDF2ë¡œ {len(reader.pages)}í˜ì´ì§€ ì¶”ì¶œ ì™„ë£Œ"
    except:
        pass

    return None, "í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨ â€” ìŠ¤ìº” PDFì´ê±°ë‚˜ ë³´ì•ˆ ì„¤ì •ëœ íŒŒì¼ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. OCRì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."


def get_current_formula_csv():
    """ì„¸ì…˜ì—ì„œ í˜„ì¬ ë°°í•©ë¹„ë¥¼ CSV í…ìŠ¤íŠ¸ë¡œ ê°€ì ¸ì˜¤ê¸° (ì—¬ëŸ¬ ì†ŒìŠ¤ ì²´í¬)"""
    import streamlit as st
    # 1ìˆœìœ„: current_formula_df (ë°°í•©ë¹„ì„¤ê³„ì—ì„œ ì €ì¥)
    df = st.session_state.get("current_formula_df")
    if df is not None and "ë¹„ìœ¨(%)" in df.columns:
        return df.to_csv(index=False), "ë°°í•©ë¹„ì„¤ê³„ í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜´"
    # 2ìˆœìœ„: csv_input (ë°°í•©ì—°ìŠµì—ì„œ ì €ì¥)
    csv = st.session_state.get("csv_input", "")
    if csv.strip():
        return csv, "ë°°í•©ì—°ìŠµ í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜´"
    # 3ìˆœìœ„: ai_formulation (AI ì¹´ë“œì—ì„œ ìƒì„±)
    form = st.session_state.get("ai_formulation")
    if form and "ingredients" in form:
        rows = ["ì›ë£Œëª…,ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰"]
        for ing in form["ingredients"]:
            rows.append(f"{ing['name']},{ing['pct']},{ing['function']},{ing['grade']}")
        return "\n".join(rows), f"AI ì¹´ë“œ ({form.get('productName','')})ì—ì„œ ê°€ì ¸ì˜´"
    return "", "ë°°í•©ë¹„ ì—†ìŒ"


# â”â”â” ì±—ë´‡ í—¬í¼ â”â”â”
def get_api_key():
    """Streamlit secrets ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ì—ì„œ OpenAI API í‚¤ ê°€ì ¸ì˜¤ê¸°"""
    import streamlit as st
    try:
        key = st.secrets.get("OPENAI_API_KEY", "")
        if key:
            return key
    except:
        pass
    key = os.environ.get("OPENAI_API_KEY", "")
    if key:
        return key
    return st.session_state.get("api_key", "")


def render_api_key_input():
    """ì‚¬ì´ë“œë°”ì— API í‚¤ ì…ë ¥ UI"""
    import streamlit as st
    key = get_api_key()
    if not key:
        with st.sidebar:
            st.markdown("---")
            st.markdown("### ğŸ”‘ OpenAI API í‚¤")
            st.caption("AI ì±—ë´‡Â·ë¶„ì„ì„ ì‚¬ìš©í•˜ë ¤ë©´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤")
            input_key = st.text_input("API Key", type="password", key="api_key_input",
                                       placeholder="sk-proj-...")
            if input_key:
                st.session_state.api_key = input_key
                st.success("âœ… API í‚¤ ì„¤ì •ë¨")
                st.rerun()
            st.markdown("[ğŸ”— API í‚¤ ë°œê¸‰](https://platform.openai.com/api-keys)")
    return bool(get_api_key())


def render_chatbot(page_key, page_context="", system_extra=""):
    """ê° í˜ì´ì§€ í•˜ë‹¨ì— ì±—ë´‡ UI ë Œë”ë§"""
    import streamlit as st

    st.markdown("---")
    st.markdown("### ğŸ’¬ AI ì—°êµ¬ì› ì±—ë´‡")

    # API í‚¤ ìƒíƒœ
    has_key = render_api_key_input()
    if not has_key:
        st.caption("âš ï¸ API í‚¤ ë¯¸ì„¤ì • â€” ê¸°ë³¸ ì‘ë‹µë§Œ ì œê³µë©ë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")

    # ì„¸ì…˜ ì´ˆê¸°í™”
    chat_key = f"chat_history_{page_key}"
    if chat_key not in st.session_state:
        st.session_state[chat_key] = []

    # ì´ì „ ëŒ€í™” í‘œì‹œ
    for msg in st.session_state[chat_key]:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    # ì…ë ¥
    user_input = st.chat_input(f"ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” ({page_key} ê´€ë ¨)", key=f"chat_input_{page_key}")

    if user_input:
        # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
        st.session_state[chat_key].append({"role": "user", "content": user_input})
        with st.chat_message("user"):
            st.markdown(user_input)

        # AI ì‘ë‹µ ìƒì„±
        with st.chat_message("assistant"):
            with st.spinner("ğŸ¤– ìƒê° ì¤‘..."):
                response = _get_chat_response(user_input, st.session_state[chat_key], page_context, system_extra)
            st.markdown(response)

        st.session_state[chat_key].append({"role": "assistant", "content": response})


def _get_chat_response(user_input, history, page_context, system_extra):
    """ì±—ë´‡ ì‘ë‹µ ìƒì„± (API í˜¸ì¶œ ë˜ëŠ” í´ë°±)"""
    system_prompt = f"""ë‹¹ì‹ ì€ ì‹í’ˆê³µí•™ R&D ì „ë¬¸ ì—°êµ¬ì›ì…ë‹ˆë‹¤.
í•œêµ­ ì‹í’ˆ ì‚°ì—…, ìŒë£Œ ì œì¡°, HACCP, ë°°í•©ë¹„ ì„¤ê³„, ì›ê°€ ë¶„ì„, ì‹í’ˆ ê·œì œì— ëŒ€í•´ ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.
í•­ìƒ í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. ê°„ê²°í•˜ê³  ì‹¤ë¬´ì ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.

í˜„ì¬ í˜ì´ì§€ ì»¨í…ìŠ¤íŠ¸:
{page_context}

{system_extra}"""

    # ìµœê·¼ 6ê°œ ë©”ì‹œì§€ë§Œ ì „ì†¡ (í† í° ì ˆì•½)
    recent = history[-6:] if len(history) > 6 else history
    messages = [{"role": m["role"], "content": m["content"]} for m in recent if m["role"] in ("user","assistant")]
    # ë§ˆì§€ë§‰ì´ userê°€ ì•„ë‹ˆë©´ ì¶”ê°€
    if not messages or messages[-1]["role"] != "user":
        messages.append({"role": "user", "content": user_input})

    try:
        import requests as req
        api_key = get_api_key()
        if not api_key:
            return _fallback_response(user_input)
        # system ë©”ì‹œì§€ë¥¼ messages ì•ì— ì‚½ì…
        api_messages = [{"role": "system", "content": system_prompt}] + messages
        resp = req.post(
            "https://api.openai.com/v1/chat/completions",
            headers={
                "Content-Type": "application/json",
                "Authorization": f"Bearer {api_key}",
            },
            json={
                "model": "gpt-4o-mini",
                "max_tokens": 1000,
                "messages": api_messages,
            },
            timeout=30,
        )
        if resp.status_code == 200:
            data = resp.json()
            return data["choices"][0]["message"]["content"]
        elif resp.status_code == 401:
            return "âŒ API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ ì˜¬ë°”ë¥¸ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
        else:
            return f"âš ï¸ API ì˜¤ë¥˜ (status {resp.status_code}). ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
    except Exception as e:
        pass

    # í´ë°±: í‚¤ì›Œë“œ ê¸°ë°˜ ì‘ë‹µ
    return _fallback_response(user_input)


def _fallback_response(q):
    """API í˜¸ì¶œ ë¶ˆê°€ ì‹œ í‚¤ì›Œë“œ ê¸°ë°˜ ì‘ë‹µ"""
    q_lower = q.lower()

    if any(k in q_lower for k in ["ë°°í•©", "ë¹„ìœ¨", "100%", "ë°±ë¶„ìœ¨"]):
        return """ë°°í•©ë¹„ëŠ” ë°˜ë“œì‹œ **100% ê¸°ì¤€**ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

**ê¸°ë³¸ êµ¬ì¡°:**
- ì •ì œìˆ˜: 80~90% (ìŒë£Œì˜ ê¸°ë³¸)
- ê°ë¯¸ë£Œ: 5~12% (ê³¼ë‹¹í¬ë„ë‹¹ì•¡, ì„¤íƒ• ë“±)
- ì‚°ë¯¸ë£Œ: 0.3~0.8% (êµ¬ì—°ì‚° ë“±)
- í–¥ë£Œ: 0.1~0.5%
- ê¸°íƒ€ ì²¨ê°€ë¬¼: ë‚˜ë¨¸ì§€

í•©ê³„ê°€ 100%ê°€ ë˜ì§€ ì•Šìœ¼ë©´ 'ğŸ”„ ì •ê·œí™”' ë²„íŠ¼ìœ¼ë¡œ ìë™ ì¡°ì • ê°€ëŠ¥í•©ë‹ˆë‹¤."""

    if any(k in q_lower for k in ["ì›ê°€", "ë‹¨ê°€", "ë¹„ìš©", "ê°€ê²©"]):
        return """**ì›ê°€ ë¶„ì„ ë°©ë²•:**
1. ë°°í•©ë¹„(%)ì— ê¸°ì¤€ ìš©ëŸ‰ì„ ê³±í•´ í•¨ëŸ‰(g) ê³„ì‚°
2. í•¨ëŸ‰ Ã— ë‹¨ê°€(ì›/kg) / 1000 = 1ë³‘ë‹¹ ì›ê°€
3. ì›ê°€ì— ë°°ì¹˜ ìˆ˜ëŸ‰ì„ ê³±í•˜ë©´ ì´ ì›ì¬ë£Œë¹„

**ë‹¨ê°€ DBì— ì—†ëŠ” ì›ë£Œ**ëŠ” [ğŸ’° ì›ê°€ë¶„ì„ â†’ ğŸ”§ ë‹¨ê°€ ìˆ˜ì •] íƒ­ì—ì„œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ ìŒë£Œ 1ë³‘(500ml) ì›ì¬ë£Œë¹„ëŠ” 100~500ì› ìˆ˜ì¤€ì…ë‹ˆë‹¤."""

    if any(k in q_lower for k in ["haccp", "ccp", "ê³µì •", "ì‚´ê· ", "ìœ„í•´"]):
        return """**ìŒë£Œ ì œì¡° í•µì‹¬ CCP (Critical Control Point):**

1. **CCP-1 ì‚´ê· **: HTST 72Â°C/15ì´ˆ ë˜ëŠ” UHT 135Â°C/2ì´ˆ
2. **CCP-2 ì¶©ì „Â·ë°€ë´‰**: ë¬´ê·  ì¶©ì „ ì‹œìŠ¤í…œ, ë°€ë´‰ ê¸°ë°€ ê²€ì‚¬

**ëª¨ë‹ˆí„°ë§ í•„ìˆ˜ì‚¬í•­:**
- ì—°ì† ì˜¨ë„ ê¸°ë¡ì¥ì¹˜ (RTD)
- ëª¨ë‹ˆí„°ë§ ì£¼ê¸° & í•œê³„ê¸°ì¤€ ì„¤ì •
- ì´íƒˆ ì‹œ ê°œì„ ì¡°ì¹˜ ì ˆì°¨

PDFë¥¼ ì—…ë¡œë“œí•˜ì‹œë©´ í•´ë‹¹ ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."""

    if any(k in q_lower for k in ["í‘œì‹œ", "ë¼ë²¨", "ê·œì œ", "ì‹í’ˆë“±"]):
        return """**ì‹í’ˆë“±ì˜ í‘œì‹œê¸°ì¤€ í•„ìˆ˜ í•­ëª© (10ê°€ì§€):**

1. ì œí’ˆëª… / 2. ì‹í’ˆìœ í˜• / 3. ì—…ì†Œëª…Â·ì†Œì¬ì§€
4. ì†Œë¹„ê¸°í•œ / 5. ë‚´ìš©ëŸ‰ / 6. ì›ì¬ë£Œëª… (í•¨ëŸ‰ìˆœ)
7. ì˜ì–‘ì„±ë¶„ (9ê°€ì§€) / 8. ì•Œë ˆë¥´ê¸° ìœ ë°œë¬¼ì§ˆ (22ì¢…)
9. ë³´ê´€ë°©ë²• / 10. ì£¼ì˜ì‚¬í•­

**ìŒë£Œë¥˜ ì¶”ê°€:** ì¹´í˜ì¸ í•¨ëŸ‰(ê³ ì¹´í˜ì¸ ì‹œ), ê³¼ì¦™í•¨ëŸ‰(10% ì´ìƒ ì‹œ)

[ğŸ·ï¸ í‘œì‹œì‚¬í•­] í˜ì´ì§€ì—ì„œ ì‘ì„±í•˜ë©´ ì í•©ì„± ë¹„êµí‘œë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤."""

    if any(k in q_lower for k in ["pdf", "ì—…ë¡œë“œ", "ë¬¸ì„œ"]):
        return """**PDF ì—…ë¡œë“œ ë°©ë²•:**
1. ì‚¬ì´ë“œë°”ì˜ íŒŒì¼ ì—…ë¡œë”ì—ì„œ PDF ì„ íƒ
2. í…ìŠ¤íŠ¸ê°€ ìë™ ì¶”ì¶œë©ë‹ˆë‹¤
3. ì¶”ì¶œëœ ë‚´ìš© ê¸°ë°˜ìœ¼ë¡œ AI ë¶„ì„ ê°€ëŠ¥

**ì§€ì›:** ì¼ë°˜ PDF (í…ìŠ¤íŠ¸ ê¸°ë°˜)
**ë¯¸ì§€ì›:** ìŠ¤ìº”ëœ ì´ë¯¸ì§€ PDF (OCR í•„ìš”)

ì‹í’ˆë“±ì˜ í‘œì‹œê¸°ì¤€, HACCP ê´€ë¦¬ê¸°ì¤€ì„œ, ê³µì •ë„ ë“±ì„ ì—…ë¡œë“œí•˜ë©´ ë” ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."""

    return f"""í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•´ ë„ì›€ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

í˜„ì¬ API ì—°ê²°ì´ ë˜ì§€ ì•Šì•„ ìƒì„¸ ë‹µë³€ì´ ì œí•œë©ë‹ˆë‹¤. ë‹¤ìŒì„ ì‹œë„í•´ë³´ì„¸ìš”:

1. ğŸ“ ì‚¬ì´ë“œë°”ì—ì„œ ê´€ë ¨ ìƒ˜í”Œ/í‘œì¤€ë°°í•©ë¹„ ë¶ˆëŸ¬ì˜¤ê¸°
2. ğŸ“„ ê´€ë ¨ PDF ë¬¸ì„œ ì—…ë¡œë“œí•˜ì—¬ AI ë¶„ì„ ì‹¤í–‰
3. ê° í˜ì´ì§€ì˜ ë„ì›€ë§ê³¼ ê°€ì´ë“œë¥¼ ì°¸ê³ 

ë” êµ¬ì²´ì ì¸ í‚¤ì›Œë“œ(ë°°í•©ë¹„, ì›ê°€, ê³µì •, í‘œì‹œì‚¬í•­ ë“±)ë¡œ ì§ˆë¬¸í•˜ì‹œë©´ ë” ì •í™•í•œ ë‹µë³€ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."""
